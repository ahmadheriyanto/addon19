<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- List view for Incoming Staging -->
    <record id="view_incoming_staging_list" model="ir.ui.view">
        <field name="name">incoming_staging.list</field>
        <field name="model">incoming_staging</field>
        <field name="arch" type="xml">
            <list string="Incoming Staging" create="true" edit="true" delete="true" default_order="courier_sort_score desc">
                <field name="resi_no"/>
                <field name="datetime_string"/>
                <field name="partner_id"/>  
                <field name="partner_type"/>
                <field name="type"/>
                <field name="status"/>
                <field name="principal_courier"/>
                <field name="courier_priority"/>
                <field name="principal_customer_name"/>
                <field name="principal_customer_address"/>
            </list>
        </field>
    </record>

    <!-- Form view for Incoming Staging, includes One2many product lines -->
    <record id="view_incoming_staging_form" model="ir.ui.view">
        <field name="name">incoming_staging.form</field>
        <field name="model">incoming_staging</field>
        <field name="arch" type="xml">
            <form string="Incoming Staging">
                <header>
                    <div style="float:left; width:128px; height:128px; margin-right:12px;">
                        <field name="qr_image" widget="image" class="o_form_image" options="{'size': [128,128]}" />
                    </div>
                    <!-- Call the model method directly. This avoids unresolved XML id issues during module load. -->
                    <button name="action_create_transfer"
                            type="object"
                            string="Create Transfer"
                            class="btn-primary"
                            invisible="not (status == 'open' and type == 'inbound')"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="resi_no" readonly="1"/>
                            <field name="type"/>
                            <field name="status"/>
                            <field name="principal_courier"/>
                            <field name="courier_priority" readonly="1"/>                            
                        </group>
                        <group>
                            <field name="datetime_string"/>
                            <field name="partner_id"/>                            
                            <field name="partner_type"/>
                            <field name="principal_customer_name"/>
                            <field name="principal_customer_address"/>
                        </group>
                    </group>

                    <div style="clear:both"/>
                    <notebook>
                        <page string="Products">
                            <field name="products">
                                <list editable="bottom" string="Product Lines">
                                    <field name="product_no"/>
                                    <field name="product_nanme"/>
                                    <field name="product_qty" widget="integer"/>
                                    <field name="product_uom"/>
                                    <field name="tracking_type"/>
                                    <field name="tracking_no"/>
                                </list>
                                <form>
                                    <sheet>
                                        <group>
                                            <field name="product_no"/>
                                            <field name="product_nanme"/>
                                            <field name="product_qty" widget="integer"/>
                                            <field name="product_uom"/>
                                        </group>
                                        <group>
                                            <field name="tracking_type"/>
                                            <field name="tracking_no"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>
                        <page string="Debug / QR">
                            <group>
                                <label for="qr_payload" string="QR Payload (read-only)"/>
                                <field name="qr_payload" readonly="1" nolabel="1" widget="text"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <footer/>
            </form>
        </field>
    </record>

    <!-- List view for Incoming Staging Product lines -->
    <record id="view_incoming_staging_product_list" model="ir.ui.view">
        <field name="name">incoming_staging.product.list</field>
        <field name="model">incoming_staging_product</field>
        <field name="arch" type="xml">
            <list string="Incoming Staging Product" create="true" edit="true" delete="true">
                <field name="product_no"/>
                <field name="product_nanme"/>
                <field name="product_qty" widget="float" options="{'precision': 'Product Unit of Measure'}"/>
                <field name="product_uom"/>
                <field name="tracking_type"/>
                <field name="tracking_no"/>
            </list>
        </field>
    </record>

    <!-- Server action: run Create Transfer on selected incoming_staging records
         and send a notification to the current user via the bus (no top-level return). -->
    <record id="action_server_create_transfer" model="ir.actions.server">
        <field name="name">⬇️ Create Transfer from Incoming Staging</field>
        <field name="model_id" ref="fulfillment.model_incoming_staging"/>
        <field name="binding_model_id" ref="fulfillment.model_incoming_staging"/>
        <field name="state">code</field>
        <field name="code">active_ids = env.context.get('active_ids', []) or []
records = env['incoming_staging'].browse(active_ids)
# Process any open records (both inbound and forder)
to_process = records.filtered(lambda r: r.status == 'open')
skipped = records - to_process
messages = []
results = []
if to_process:
    try:
        # action_create_transfer dispatches to receive/pick as appropriate
        results = to_process.sudo().action_create_transfer()
    except Exception as e:
        results = []
        messages.append("Error when creating transfers: %s" % (str(e),))
# Build human friendly messages from results + skipped
for r in results:
    if isinstance(r, dict):
        if r.get('picking_id'):
            messages.append("Staging %s → Picking %s (state=%s)" % (r.get('staging_id'), r.get('picking_id'), r.get('state')))
        else:
            messages.append("Staging %s → Error: %s" % (r.get('staging_id'), r.get('error', 'no details')))
    else:
        messages.append(str(r))
for s in skipped:
    messages.append("Skipped %s (status=%s, type=%s)" % (s.id, s.status, s.type))

msg = "\\n".join(messages) or "No records processed."

# Prefer sending notification to current user (env.uid) — more reliable in typical setups.
try:
    env['bus.bus'].sendone(
        ('res.users', env.uid),
        {'type': 'simple_notification', 'title': 'Create Transfer', 'message': msg, 'sticky': True}
    )
except Exception:
    # Fallback to broadcast if sending to env.uid fails
    try:
        env['bus.bus'].sendone(
            ('res.users', 0),
            {'type': 'simple_notification', 'title': 'Create Transfer', 'message': msg, 'sticky': True}
        )
    except Exception:
        # swallow errors to avoid breaking the server action
        pass</field>
    </record>

    <!-- Action to open Incoming Staging (list,form) -->
    <record id="action_incoming_staging" model="ir.actions.act_window">
        <field name="name">Incoming Staging</field>
        <field name="res_model">incoming_staging</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="view_incoming_staging_list"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Incoming staging records are imported from your external system via the JSON-RPC API.
            </p>
        </field>
    </record>

    <!-- Action to open mobile scanner -->
    <record id="action_mobile_qr_scanner" model="ir.actions.act_url">
        <field name="name">Mobile QR Scanner</field>
        <field name="url">/mobile_warehouse</field>
        <field name="target">self</field>
    </record>

    <!-- Menu: Fulfillment under Inventory root, and Incoming Staging submenu -->
    <menuitem id="menu_fulfillment_root"
              name="Fulfillment"
              parent="stock.menu_stock_root"
              sequence="80"/>

    <menuitem id="menu_incoming_staging"
              name="Incoming Staging"
              parent="menu_fulfillment_root"
              action="action_incoming_staging"
              sequence="10"/>

    <menuitem id="menu_mobile_qr_scanner"
            name="Mobile QR Scanner"
            parent="menu_fulfillment_root"
            action="action_mobile_qr_scanner"
            sequence="20"/>
</odoo>